<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>후비 HUBEE</title>
  <link rel="manifest" href="/static/manifest.json" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" />
  <meta name="theme-color" content="#ffffff" />
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      margin: 0;
      padding: 0;
      background: #eaf6ff;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #ffffff;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid #ddd;
      gap: 0.5rem;
      position: relative;
    }
    .logo {
      height: 40px;
    }
    .title {
      font-weight: bold;
      font-size: 1.3rem;
    }
    .search-btn {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 1.2rem;
      position: absolute;
      right: 2rem;
    }
    .info-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
    }
    #chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 2rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .bubble {
      padding: 0.75rem 1rem;
      border-radius: 20px;
      max-width: 100%; /* ✅ 기존: 75% → 넓혀서 텍스트가 더 자연스럽게 보이게 함 */
      word-wrap: break-word;
      overflow-wrap: anywhere; /* ✅ 긴 단어/링크 줄바꿈 허용 */
      white-space: normal; /* ✅ 기존: pre-wrap → 자동 줄바꿈 */
      font-size: 0.95rem;
      line-height: 1.5;
    }
    .user {
      align-self: flex-end;
      background: #003b6f;
      color: #fff;
    }
    .bot {
      align-self: flex-start;
      background: #ffffff;
      border: 1px solid #ddd;
      color: #333;
      display: flex;
      flex-wrap: wrap; /* ✅ 긴 문장도 잘 감싸지도록 설정 */
      align-items: center;
      gap: 0.5rem;
    }
    .bot-icon {
      height: 28px;
      width: 28px;
    }
    #input-area {
      display: flex;
      padding: 0.75rem;
      background: #fff;
      border-top: 1px solid #ccc;
      gap: 0.5rem;
      align-items: center;
    }
    #userInput {
      flex: 1;
      padding: 0.6rem;
      border: 1px solid #ccc;
      border-radius: 20px;
      outline: none;
    }
    button {
      padding: 0;
      border: none;
      border-radius: 50%;
      background-color: transparent;
      cursor: pointer;
    }
    #toggleExamples {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 46px;
      height: 46px;
      font-size: 24px;
      border-radius: 50%;
      background-color: #e7f0ff;
      border: 2px solid #a5cfff;
    }
    #send-btn {
      width: 35px;
      height: 35px;
      background-color: #81d4fa;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #end-btn {
      width: 35px;
      height: 35px;
      background-color: #f48fb1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .example-question {
      display: block;
      width: 100%;
      text-align: left;
      padding: 6px 12px;
      background-color: #f9f9f9;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .example-question:hover {
      background-color: #eef6ff;
    }
  </style>
</head>
<body>
  <header>
    <div id="installBanner" style="display: none; position: fixed; top: 0; left: 0; width: 100%; background: #eaf6ff; text-align: center; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 9999;">
      <span>후비를 설치하고 더 편하게 이용해보세요! 🎄</span>
      <button id="installBtn" style="margin-left: 10px; padding: 0.5rem 1rem; background-color: #0099ff; color: white; border: none; border-radius: 8px;">설치하기</button>
      <button id="closeBannerBtn" style="margin-left: 10px; padding: 0.5rem 1rem; background-color: #ccc; color: black; border: none; border-radius: 8px;">닫기</button>
    </div>

    <div class="info-icon" onclick="openModal()">
      <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="12" fill="#444444" />
        <text x="12" y="18" text-anchor="middle" font-size="18" fill="white" font-family="Arial, sans-serif" font-weight="bold">i</text>
      </svg>
    </div>
    <img src="/static/icons/hufs.png" class="logo" alt="로고" />
    <div class="title">HUFS 비서, HUBEE</div>
    <button class="search-btn" onclick="viewHistory()">🔍</button>
  </header>

  <div id="infoModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:white; z-index:1000;">
    <div style="background:white; max-width:500px; margin:10vh auto; padding:20px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.3); position:relative; max-height:80vh; overflow-y:auto;">
      <h3>📘 HUFS 비서, HUBEE 사용 방법</h3>
      <p>안녕하세요! 한국외대 챗봇 HUBEE입니다.<br>저는 학교 공지사항이나 학사일정등 다양한 자료를 가지고 있어요!</p>
      <ul>
        <li>📅 최신 학사 공지가 뭐예요?</li>
        <li>🍽 오늘 학식 메뉴는?</li>
        <li>🏠 기숙사 입실은 언제예요?</li>
        <li>🌍 교환학생 조건이 궁금해요</li>
      </ul>
      <p>아래 파란색 버튼을 누르면 질문이 전송됩니다. <br> 옆의 빨간버튼을 누르면 채팅이 종료되고 새로운 채팅을 시작하실 수 있습니다!<br> 상단 🔍 버튼을 눌러 이전 대화 내용도 확인할 수 있어요!</p>
      <h3>📘 HUFS Secretary, how to use HUBEE</h3>
      <p>Hello! I'm HUBEE, a chatbot of Hankuk University of Foreign Studies.<br>I have various materials such as school announcements and academic schedules!</p>
      <p>Ask the HUBEE the following questions:</p>
      <ul>
        <li>📅 What is the recent academic notice?</li>
        <li> 🍽 What's on the menu today?</li>
        <li>🏠 When do you enter the dorm?</li>
        <li>🌍 I want to know the conditions of exchange students</li>
      </ul>
      <p> Press the blue button below to send you a question. <br> Press the red button to end the chat and start a new one! <br> Press the 🔍 button at the top to check out the previous conversation as well!</p>
      <button onclick="closeModal()" style="margin-top: 10px; padding: 6px 14px; background: #003b6f; color: white; border: none; border-radius: 6px;">닫기</button>
    </div>
  </div>

  <div id="chat-box">
    <div class="bubble bot"><img class='bot-icon' src='/static/icons/icon3.png'>안녕하세요! 저는 한국외대 챗봇 후비입니다. 무엇을 도와드릴까요?😊<br>Hello! I'm HUBee, the HUFS chatbot. How can I help you today? 😊<br>你好！我是韩国外国语大学聊天机器人HUBee。请问有什么可以帮您的吗？😊<br>こんにちは！私は韓国外国語大学のチャットボットHUBeeです。ご用件をどうぞ😊<br>Xin chào! Tôi là HUBee, chatbot của Đại học Ngoại ngữ Hàn Quốc. Tôi có thể giúp gì cho bạn? 😊</div>
  </div>

  <div id="input-area">
    <div style="position: relative;">
      <button id="toggleExamples">💬</button>
      <div id="exampleList" style="display: none; position: absolute; bottom: 50px; left: 0; background: white; border: 1px solid #ccc; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); z-index: 10; white-space: nowrap;">
        <button class="example-question">최신 학사공지 알고싶어요!</button><br />
        <button class="example-question">오늘 학식은 뭐예요?</button><br />
        <button class="example-question">기숙사 신청은 언제 해요?</button><br />
        <button class="example-question">교환학생 가고 싶어요!</button><br />
        <button class="example-question">시험이 언제예요?</button>
      </div>
    </div>
    <input id="userInput" placeholder="질문을 입력하세요" />
    <button id="send-btn" onclick="sendToGPT()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none">
        <path d="M3 2v20l19-10L3 2z" fill="#ffffff"/>
      </svg>
    </button>
    <button id="end-btn" onclick="clearChat()">
      <svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 40 40'>
        <circle cx='20' cy='20' r='20' fill='#f48fb1'/>
        <rect x='6' y='8' width='28' height='28' fill='white' rx='2'/>
      </svg>
    </button>
  </div>


  <!-- JavaScript는 여기! -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }


    let history = [];
    let allConversations = [];

    window.sendToGPT = async function () {
      const inputEl = document.getElementById("userInput");
      const userInput = inputEl.value.trim();
      if (!userInput) return;

      const chatBox = document.getElementById("chat-box");
      chatBox.innerHTML += `<div class='bubble user'>🙋‍♀️ ${userInput}</div>`;
      inputEl.value = "";
      chatBox.scrollTop = chatBox.scrollHeight;
      history.push({ role: 'user', content: userInput });

      const res = await fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: userInput })
      });

      const data = await res.json();
      const formatted = data.answer 
        .replace(/【\d+:\d+†[^】]+】/g, '') // 모든 출처 제거
        .replace(/(https?:\/\/[^\s\)\]\}]+)/g, 
          '<a href="$1" target="_blank" style="color:#1a0dab;">$1</a>')
        .replace(/\n/g, '<br>');

      chatBox.innerHTML += `<div class='bubble bot'><img class='bot-icon' src='/static/icons/icon3.png'> ${formatted}</div>`;
      chatBox.scrollTop = chatBox.scrollHeight;
      history.push({ role: 'bot', content: data.answer });
    };

    window.clearChat = function () {
      if (history.length > 0) {
        allConversations.push([...history]);
        history = [];
      }
      document.getElementById("chat-box").innerHTML = "";
    };

    window.viewHistory = function () {
      if (allConversations.length === 0) {
        alert("이전 대화 기록이 없습니다.");
        return;
      }
      let output = allConversations.map((conv, idx) => {
        return `📂 대화 ${idx + 1}\n` + conv.map(h => `${h.role === 'user' ? '🙋‍♀️' : '🤖'} ${h.content}`).join('\n');
      }).join('\n\n----------------------\n\n');
      alert(output);
    };

    window.openModal = function () {
      document.getElementById("infoModal").style.display = "block";
    };

    window.closeModal = function () {
      document.getElementById("infoModal").style.display = "none";
    };

    document.addEventListener("DOMContentLoaded", function () {
      const toggleBtn = document.getElementById("toggleExamples");
      const list = document.getElementById("exampleList");

      toggleBtn.addEventListener("click", () => {
        list.style.display = list.style.display === "none" ? "block" : "none";
      });

      // 예시 질문 버튼 클릭 → 질문 입력 + 전송
      document.querySelectorAll(".example-question").forEach(btn => {
        btn.addEventListener("click", () => {
          const text = btn.innerText;
          document.getElementById("userInput").value = text;
          list.style.display = "none";
          sendToGPT();
        });
      });

      // ✅ Enter 키 입력은 딱 한 번만 등록!
      document.getElementById("userInput").addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault(); // 줄바꿈 방지
          sendToGPT();
        }
      });
    });
  </script>
  <script>
  let deferredPrompt = null;

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;

    if (localStorage.getItem("hubeeInstallPromptShown")) return;

    const banner = document.getElementById("installBanner");
    if (banner) banner.style.display = "block";

    const installBtn = document.getElementById("installBtn");
    if (installBtn) {
      installBtn.addEventListener("click", async () => {
        banner.style.display = "none";
        localStorage.setItem("hubeeInstallPromptShown", "true");
        deferredPrompt.prompt();
        const result = await deferredPrompt.userChoice;
        console.log("설치 응답:", result.outcome);
        deferredPrompt = null;
      });
    }

    const closeBtn = document.getElementById("closeBannerBtn");
    if (closeBtn) {
      closeBtn.addEventListener("click", () => {
        banner.style.display = "none";
        localStorage.setItem("hubeeInstallPromptShown", "true");
      });
    }
  });

  // ✅ iOS Safari 대응
  const isIOS = /iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase());
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  if (isIOS && isSafari) {
    const banner = document.getElementById("installBanner");
    if (!localStorage.getItem("hubeeInstallPromptShown") && banner) {
      banner.style.display = "block";
      document.getElementById("installBtn").innerText = "Safari 하단 중앙의 공유 아이콘을 눌러 '홈 화면에 추가'를 선택해 주세요!";

      const closeBtn = document.getElementById("closeBannerBtn");
      if (closeBtn) {
        closeBtn.addEventListener("click", () => {
          banner.style.display = "none";
          localStorage.setItem("hubeeInstallPromptShown", "true");
        });
      }
    }
  }
</script>

</body>
</html>