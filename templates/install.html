<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í›„ë¹„ HUBEE</title>
  <link rel="manifest" href="/static/manifest.json" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" />
  <meta name="theme-color" content="#ffffff" />
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      margin: 0;
      padding: 0;
      background: #eaf6ff;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #ffffff;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid #ddd;
      gap: 0.5rem;
      position: relative;
    }
    .logo {
      height: 40px;
    }
    .title {
      font-weight: bold;
      font-size: 1.3rem;
    }
    .search-btn {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 1.2rem;
      position: absolute;
      right: 2rem;
    }
    .info-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
    }
    #chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 2rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .bubble {
      padding: 0.75rem 1rem;
      border-radius: 20px;
      max-width: 100%; /* âœ… ê¸°ì¡´: 75% â†’ ë„“í˜€ì„œ í…ìŠ¤íŠ¸ê°€ ë” ìì—°ìŠ¤ëŸ½ê²Œ ë³´ì´ê²Œ í•¨ */
      word-wrap: break-word;
      overflow-wrap: anywhere; /* âœ… ê¸´ ë‹¨ì–´/ë§í¬ ì¤„ë°”ê¿ˆ í—ˆìš© */
      white-space: normal; /* âœ… ê¸°ì¡´: pre-wrap â†’ ìë™ ì¤„ë°”ê¿ˆ */
      font-size: 0.95rem;
      line-height: 1.5;
    }
    .user {
      align-self: flex-end;
      background: #003b6f;
      color: #fff;
    }
    .bot {
      align-self: flex-start;
      background: #ffffff;
      border: 1px solid #ddd;
      color: #333;
      display: flex;
      flex-wrap: wrap; /* âœ… ê¸´ ë¬¸ì¥ë„ ì˜ ê°ì‹¸ì§€ë„ë¡ ì„¤ì • */
      align-items: center;
      gap: 0.5rem;
    }
    .bot-icon {
      height: 28px;
      width: 28px;
    }
    #input-area {
      display: flex;
      padding: 0.75rem;
      background: #fff;
      border-top: 1px solid #ccc;
      gap: 0.5rem;
      align-items: center;
    }
    #userInput {
      flex: 1;
      padding: 0.6rem;
      border: 1px solid #ccc;
      border-radius: 20px;
      outline: none;
    }
    button {
      padding: 0;
      border: none;
      border-radius: 50%;
      background-color: transparent;
      cursor: pointer;
    }
    #toggleExamples {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 46px;
      height: 46px;
      font-size: 24px;
      border-radius: 50%;
      background-color: #e7f0ff;
      border: 2px solid #a5cfff;
    }
    #send-btn {
      width: 35px;
      height: 35px;
      background-color: #81d4fa;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #end-btn {
      width: 35px;
      height: 35px;
      background-color: #f48fb1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .example-question {
      display: block;
      width: 100%;
      text-align: left;
      padding: 6px 12px;
      background-color: #f9f9f9;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .example-question:hover {
      background-color: #eef6ff;
    }
  </style>
</head>
<body>
  <header>
    <div id="installBanner" style="display: none; position: fixed; top: 0; left: 0; width: 100%; background: #eaf6ff; text-align: center; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 9999;">
      <span>í›„ë¹„ë¥¼ ì„¤ì¹˜í•˜ê³  ë” í¸í•˜ê²Œ ì´ìš©í•´ë³´ì„¸ìš”! ğŸ„</span>
      <button id="installBtn" style="margin-left: 10px; padding: 0.5rem 1rem; background-color: #0099ff; color: white; border: none; border-radius: 8px;">ì„¤ì¹˜í•˜ê¸°</button>
      <button id="closeBannerBtn" style="margin-left: 10px; padding: 0.5rem 1rem; background-color: #ccc; color: black; border: none; border-radius: 8px;">ë‹«ê¸°</button>
    </div>

    <div class="info-icon" onclick="openModal()">
      <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="12" fill="#444444" />
        <text x="12" y="18" text-anchor="middle" font-size="18" fill="white" font-family="Arial, sans-serif" font-weight="bold">i</text>
      </svg>
    </div>
    <img src="/static/icons/hufs.png" class="logo" alt="ë¡œê³ " />
    <div class="title">HUFS ë¹„ì„œ, HUBEE</div>
    <button class="search-btn" onclick="viewHistory()">ğŸ”</button>
  </header>

  <div id="infoModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:white; z-index:1000;">
    <div style="background:white; max-width:500px; margin:10vh auto; padding:20px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.3); position:relative; max-height:80vh; overflow-y:auto;">
      <h3>ğŸ“˜ HUFS ë¹„ì„œ, HUBEE ì‚¬ìš© ë°©ë²•</h3>
      <p>ì•ˆë…•í•˜ì„¸ìš”! í•œêµ­ì™¸ëŒ€ ì±—ë´‡ HUBEEì…ë‹ˆë‹¤.<br>ì €ëŠ” í•™êµ ê³µì§€ì‚¬í•­ì´ë‚˜ í•™ì‚¬ì¼ì •ë“± ë‹¤ì–‘í•œ ìë£Œë¥¼ ê°€ì§€ê³  ìˆì–´ìš”!</p>
      <ul>
        <li>ğŸ“… ìµœì‹  í•™ì‚¬ ê³µì§€ê°€ ë­ì˜ˆìš”?</li>
        <li>ğŸ½ ì˜¤ëŠ˜ í•™ì‹ ë©”ë‰´ëŠ”?</li>
        <li>ğŸ  ê¸°ìˆ™ì‚¬ ì…ì‹¤ì€ ì–¸ì œì˜ˆìš”?</li>
        <li>ğŸŒ êµí™˜í•™ìƒ ì¡°ê±´ì´ ê¶ê¸ˆí•´ìš”</li>
      </ul>
      <p>ì•„ë˜ íŒŒë€ìƒ‰ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì§ˆë¬¸ì´ ì „ì†¡ë©ë‹ˆë‹¤. <br> ì˜†ì˜ ë¹¨ê°„ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì±„íŒ…ì´ ì¢…ë£Œë˜ê³  ìƒˆë¡œìš´ ì±„íŒ…ì„ ì‹œì‘í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤!<br> ìƒë‹¨ ğŸ” ë²„íŠ¼ì„ ëˆŒëŸ¬ ì´ì „ ëŒ€í™” ë‚´ìš©ë„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”!</p>
      <h3>ğŸ“˜ HUFS Secretary, how to use HUBEE</h3>
      <p>Hello! I'm HUBEE, a chatbot of Hankuk University of Foreign Studies.<br>I have various materials such as school announcements and academic schedules!</p>
      <p>Ask the HUBEE the following questions:</p>
      <ul>
        <li>ğŸ“… What is the recent academic notice?</li>
        <li> ğŸ½ What's on the menu today?</li>
        <li>ğŸ  When do you enter the dorm?</li>
        <li>ğŸŒ I want to know the conditions of exchange students</li>
      </ul>
      <p> Press the blue button below to send you a question. <br> Press the red button to end the chat and start a new one! <br> Press the ğŸ” button at the top to check out the previous conversation as well!</p>
      <button onclick="closeModal()" style="margin-top: 10px; padding: 6px 14px; background: #003b6f; color: white; border: none; border-radius: 6px;">ë‹«ê¸°</button>
    </div>
  </div>

  <div id="chat-box">
    <div class="bubble bot"><img class='bot-icon' src='/static/icons/icon3.png'>ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” í•œêµ­ì™¸ëŒ€ ì±—ë´‡ í›„ë¹„ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?ğŸ˜Š<br>Hello! I'm HUBee, the HUFS chatbot. How can I help you today? ğŸ˜Š<br>ä½ å¥½ï¼æˆ‘æ˜¯éŸ©å›½å¤–å›½è¯­å¤§å­¦èŠå¤©æœºå™¨äººHUBeeã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼ŸğŸ˜Š<br>ã“ã‚“ã«ã¡ã¯ï¼ç§ã¯éŸ“å›½å¤–å›½èªå¤§å­¦ã®ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆHUBeeã§ã™ã€‚ã”ç”¨ä»¶ã‚’ã©ã†ãğŸ˜Š<br>Xin chÃ o! TÃ´i lÃ  HUBee, chatbot cá»§a Äáº¡i há»c Ngoáº¡i ngá»¯ HÃ n Quá»‘c. TÃ´i cÃ³ thá»ƒ giÃºp gÃ¬ cho báº¡n? ğŸ˜Š</div>
  </div>

  <div id="input-area">
    <div style="position: relative;">
      <button id="toggleExamples">ğŸ’¬</button>
      <div id="exampleList" style="display: none; position: absolute; bottom: 50px; left: 0; background: white; border: 1px solid #ccc; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); z-index: 10; white-space: nowrap;">
        <button class="example-question">ìµœì‹  í•™ì‚¬ê³µì§€ ì•Œê³ ì‹¶ì–´ìš”!</button><br />
        <button class="example-question">ì˜¤ëŠ˜ í•™ì‹ì€ ë­ì˜ˆìš”?</button><br />
        <button class="example-question">ê¸°ìˆ™ì‚¬ ì‹ ì²­ì€ ì–¸ì œ í•´ìš”?</button><br />
        <button class="example-question">êµí™˜í•™ìƒ ê°€ê³  ì‹¶ì–´ìš”!</button><br />
        <button class="example-question">ì‹œí—˜ì´ ì–¸ì œì˜ˆìš”?</button>
      </div>
    </div>
    <input id="userInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”" />
    <button id="send-btn" onclick="sendToGPT()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none">
        <path d="M3 2v20l19-10L3 2z" fill="#ffffff"/>
      </svg>
    </button>
    <button id="end-btn" onclick="clearChat()">
      <svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 40 40'>
        <circle cx='20' cy='20' r='20' fill='#f48fb1'/>
        <rect x='6' y='8' width='28' height='28' fill='white' rx='2'/>
      </svg>
    </button>
  </div>


  <!-- JavaScriptëŠ” ì—¬ê¸°! -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js');
      });
    }


    let history = [];
    let allConversations = [];

    window.sendToGPT = async function () {
      const inputEl = document.getElementById("userInput");
      const userInput = inputEl.value.trim();
      if (!userInput) return;

      const chatBox = document.getElementById("chat-box");
      chatBox.innerHTML += `<div class='bubble user'>ğŸ™‹â€â™€ï¸ ${userInput}</div>`;
      inputEl.value = "";
      chatBox.scrollTop = chatBox.scrollHeight;
      history.push({ role: 'user', content: userInput });

      const res = await fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: userInput })
      });

      const data = await res.json();
      const formatted = data.answer 
        .replace(/ã€\d+:\d+â€ [^ã€‘]+ã€‘/g, '') // ëª¨ë“  ì¶œì²˜ ì œê±°
        .replace(/(https?:\/\/[^\s\)\]\}]+)/g, 
          '<a href="$1" target="_blank" style="color:#1a0dab;">$1</a>')
        .replace(/\n/g, '<br>');

      chatBox.innerHTML += `<div class='bubble bot'><img class='bot-icon' src='/static/icons/icon3.png'> ${formatted}</div>`;
      chatBox.scrollTop = chatBox.scrollHeight;
      history.push({ role: 'bot', content: data.answer });
    };

    window.clearChat = function () {
      if (history.length > 0) {
        allConversations.push([...history]);
        history = [];
      }
      document.getElementById("chat-box").innerHTML = "";
    };

    window.viewHistory = function () {
      if (allConversations.length === 0) {
        alert("ì´ì „ ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      let output = allConversations.map((conv, idx) => {
        return `ğŸ“‚ ëŒ€í™” ${idx + 1}\n` + conv.map(h => `${h.role === 'user' ? 'ğŸ™‹â€â™€ï¸' : 'ğŸ¤–'} ${h.content}`).join('\n');
      }).join('\n\n----------------------\n\n');
      alert(output);
    };

    window.openModal = function () {
      document.getElementById("infoModal").style.display = "block";
    };

    window.closeModal = function () {
      document.getElementById("infoModal").style.display = "none";
    };

    document.addEventListener("DOMContentLoaded", function () {
      const toggleBtn = document.getElementById("toggleExamples");
      const list = document.getElementById("exampleList");

      toggleBtn.addEventListener("click", () => {
        list.style.display = list.style.display === "none" ? "block" : "none";
      });

      // ì˜ˆì‹œ ì§ˆë¬¸ ë²„íŠ¼ í´ë¦­ â†’ ì§ˆë¬¸ ì…ë ¥ + ì „ì†¡
      document.querySelectorAll(".example-question").forEach(btn => {
        btn.addEventListener("click", () => {
          const text = btn.innerText;
          document.getElementById("userInput").value = text;
          list.style.display = "none";
          sendToGPT();
        });
      });

      // âœ… Enter í‚¤ ì…ë ¥ì€ ë”± í•œ ë²ˆë§Œ ë“±ë¡!
      document.getElementById("userInput").addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault(); // ì¤„ë°”ê¿ˆ ë°©ì§€
          sendToGPT();
        }
      });
    });
  </script>
  <script>
  let deferredPrompt = null;

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;

    if (localStorage.getItem("hubeeInstallPromptShown")) return;

    const banner = document.getElementById("installBanner");
    if (banner) banner.style.display = "block";

    const installBtn = document.getElementById("installBtn");
    if (installBtn) {
      installBtn.addEventListener("click", async () => {
        banner.style.display = "none";
        localStorage.setItem("hubeeInstallPromptShown", "true");
        deferredPrompt.prompt();
        const result = await deferredPrompt.userChoice;
        console.log("ì„¤ì¹˜ ì‘ë‹µ:", result.outcome);
        deferredPrompt = null;
      });
    }

    const closeBtn = document.getElementById("closeBannerBtn");
    if (closeBtn) {
      closeBtn.addEventListener("click", () => {
        banner.style.display = "none";
        localStorage.setItem("hubeeInstallPromptShown", "true");
      });
    }
  });

  // âœ… iOS Safari ëŒ€ì‘
  const isIOS = /iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase());
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  if (isIOS && isSafari) {
    const banner = document.getElementById("installBanner");
    if (!localStorage.getItem("hubeeInstallPromptShown") && banner) {
      banner.style.display = "block";
      document.getElementById("installBtn").innerText = "Safari í•˜ë‹¨ ì¤‘ì•™ì˜ ê³µìœ  ì•„ì´ì½˜ì„ ëˆŒëŸ¬ 'í™ˆ í™”ë©´ì— ì¶”ê°€'ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”!";

      const closeBtn = document.getElementById("closeBannerBtn");
      if (closeBtn) {
        closeBtn.addEventListener("click", () => {
          banner.style.display = "none";
          localStorage.setItem("hubeeInstallPromptShown", "true");
        });
      }
    }
  }
</script>

</body>
</html>